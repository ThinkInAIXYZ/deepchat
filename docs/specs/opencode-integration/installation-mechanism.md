# DeepChat ACP Agent å®‰è£…å’Œä¾èµ–æ£€æµ‹æœºåˆ¶è°ƒç ”æŠ¥å‘Š

> è°ƒç ”ç›®æ ‡ï¼šäº†è§£ DeepChat å¦‚ä½•å¸®åŠ©ç”¨æˆ·å®‰è£…å’Œæ£€æµ‹ ACP Agentsï¼ˆå¦‚ Codexã€Claude Codeï¼‰
>
> æ—¥æœŸ: 2026-01-15

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

DeepChat æä¾›äº†ä¸€å¥—å®Œæ•´çš„ ACP Agent å®‰è£…å’Œä¾èµ–æ£€æµ‹æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
1. **åˆå§‹åŒ–å‘½ä»¤é…ç½®**ï¼šä¸ºæ¯ä¸ª Agent å®šä¹‰å®‰è£…å‘½ä»¤
2. **å¤–éƒ¨ä¾èµ–æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æŸ¥ç³»ç»Ÿä¾èµ–ï¼ˆå¦‚ Git Bashï¼‰
3. **äº¤äº’å¼ç»ˆç«¯**ï¼šä½¿ç”¨ xterm.js æ˜¾ç¤ºå®‰è£…è¿‡ç¨‹
4. **ä¾èµ–å¯¹è¯æ¡†**ï¼šå‹å¥½åœ°æç¤ºç”¨æˆ·å®‰è£…ç¼ºå¤±çš„ä¾èµ–
5. **è‡ªåŠ¨ç¯å¢ƒé…ç½®**ï¼šæ”¯æŒå†…ç½® runtime å’Œé•œåƒæº

---

## 1. æ ¸å¿ƒæœºåˆ¶æ¦‚è§ˆ

### 1.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢ (Renderer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ACP è®¾ç½®é¡µé¢     â”‚  â”‚ AcpTerminalDialog.vue        â”‚    â”‚
â”‚  â”‚ - Agent åˆ—è¡¨     â”‚  â”‚ - xterm.js ç»ˆç«¯              â”‚    â”‚
â”‚  â”‚ - "åˆå§‹åŒ–"æŒ‰é’®   â”‚  â”‚ - å®æ—¶è¾“å‡ºæ˜¾ç¤º               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                       â”‚                         â”‚
â”‚           â”‚ IPC                   â”‚ IPC                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ AcpDependencyDialog.vue                            â”‚    â”‚
â”‚  â”‚ - æ˜¾ç¤ºç¼ºå¤±ä¾èµ–                                      â”‚    â”‚
â”‚  â”‚ - æä¾›å®‰è£…å‘½ä»¤                                      â”‚    â”‚
â”‚  â”‚ - ä¸€é”®å¤åˆ¶                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»è¿›ç¨‹ (Main)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AcpInitHelper                                        â”‚   â”‚
â”‚  â”‚ - initializeBuiltinAgent()                           â”‚   â”‚
â”‚  â”‚ - checkExternalDependency()                          â”‚   â”‚
â”‚  â”‚ - startInteractiveSession()                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ é…ç½®æ•°æ®                                              â”‚   â”‚
â”‚  â”‚ - BUILTIN_INIT_COMMANDS                              â”‚   â”‚
â”‚  â”‚ - EXTERNAL_DEPENDENCIES                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç³»ç»Ÿç»ˆç«¯ (PTY)                            â”‚
â”‚  - æ‰§è¡Œå®‰è£…å‘½ä»¤                                              â”‚
â”‚  - è¿”å›å®æ—¶è¾“å‡º                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. åˆå§‹åŒ–å‘½ä»¤é…ç½®

### 2.1 é…ç½®ä½ç½®

**æ–‡ä»¶**: `src/main/presenter/configPresenter/acpInitHelper.ts`

### 2.2 é…ç½®ç»“æ„

```typescript
const BUILTIN_INIT_COMMANDS: Record<AcpBuiltinAgentId, InitCommandConfig> = {
  'kimi-cli': {
    commands: ['uv tool install --python 3.13 kimi-cli', 'kimi'],
    description: 'Initialize Kimi CLI'
  },
  'claude-code-acp': {
    commands: [
      'npm i -g @zed-industries/claude-code-acp',
      'npm install -g @anthropic-ai/claude-code',
      'claude'
    ],
    description: 'Initialize Claude Code ACP'
  },
  'codex-acp': {
    commands: [
      'npm i -g @zed-industries/codex-acp',
      'npm install -g @openai/codex',
      'codex'
    ],
    description: 'Initialize Codex CLI ACP'
  }
}
```

### 2.3 å‘½ä»¤è¯´æ˜

æ¯ä¸ª Agent çš„ `commands` æ•°ç»„åŒ…å«ï¼š
1. **å®‰è£…å‘½ä»¤**ï¼šå®‰è£… Agent æœ¬èº«ï¼ˆå¦‚ `npm i -g xxx`ï¼‰
2. **éªŒè¯å‘½ä»¤**ï¼šéªŒè¯å®‰è£…æˆåŠŸï¼ˆå¦‚ `xxx --version` æˆ–ç›´æ¥è¿è¡Œå‘½ä»¤åï¼‰

å‘½ä»¤ä¼šç”¨ `&&` (Unix) æˆ– `;` (Windows) è¿æ¥æ‰§è¡Œã€‚

---

## 3. å¤–éƒ¨ä¾èµ–æ£€æµ‹

### 3.1 ä¾èµ–é…ç½®

**æ–‡ä»¶**: `src/main/presenter/configPresenter/acpInitHelper.ts`

```typescript
const EXTERNAL_DEPENDENCIES: ExternalDependency[] = [
  {
    name: 'Git Bash',
    description: 'Git for Windows includes Git Bash',
    platform: ['win32'],  // ä»… Windows éœ€è¦
    checkCommand: 'git --version',
    checkPaths: [
      'C:\\Program Files\\Git\\bin\\bash.exe',
      'C:\\Program Files (x86)\\Git\\bin\\bash.exe'
    ],
    installCommands: {
      winget: 'winget install Git.Git',
      chocolatey: 'choco install git',
      scoop: 'scoop install git'
    },
    downloadUrl: 'https://git-scm.com/download/win',
    requiredFor: ['claude-code-acp']  // å“ªäº› Agent éœ€è¦è¿™ä¸ªä¾èµ–
  }
]
```

### 3.2 æ£€æµ‹æ–¹æ³•

`AcpInitHelper.checkExternalDependency()` ä½¿ç”¨ä¸‰ç§æ–¹æ³•æ£€æµ‹ä¾èµ–ï¼š

1. **å‘½ä»¤æ£€æµ‹**ï¼šæ‰§è¡Œ `checkCommand`ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡º
2. **è·¯å¾„æ£€æµ‹**ï¼šæ£€æŸ¥ `checkPaths` ä¸­çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. **ç³»ç»Ÿå·¥å…·æ£€æµ‹**ï¼šä½¿ç”¨ `which` (Unix) æˆ– `where` (Windows) æŸ¥æ‰¾å‘½ä»¤

### 3.3 ä¾èµ–æ£€æµ‹æµç¨‹

```
åˆå§‹åŒ– Agent
    â†“
æ£€æŸ¥ requiredFor åˆ—è¡¨
    â†“
éå†æ‰€æœ‰ä¾èµ–
    â†“
æ‰§è¡Œæ£€æµ‹æ–¹æ³• (1â†’2â†’3)
    â†“
å‘ç°ç¼ºå¤±ä¾èµ–ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ˜¾ç¤ºä¾èµ–å¯¹è¯æ¡† â†’ é˜»æ­¢åˆå§‹åŒ–
    â””â”€ å¦ â†’ ç»§ç»­åˆå§‹åŒ–
```

---

## 4. äº¤äº’å¼ç»ˆç«¯å®‰è£…

### 4.1 æŠ€æœ¯æ ˆ

- **åç«¯**: `node-pty` - åˆ›å»ºä¼ªç»ˆç«¯ (PTY) è¿›ç¨‹
- **å‰ç«¯**: `xterm.js` - æ˜¾ç¤ºç»ˆç«¯ç•Œé¢
- **é€šä¿¡**: Electron IPC

### 4.2 å¯åŠ¨æµç¨‹

```typescript
// 1. ç”¨æˆ·ç‚¹å‡»"åˆå§‹åŒ–"æŒ‰é’®
// 2. æ£€æŸ¥ä¾èµ–
const missingDeps = await checkRequiredDependencies(agentId)
if (missingDeps.length > 0) {
  // æ˜¾ç¤ºä¾èµ–å¯¹è¯æ¡†
  webContents.send('external-deps-required', { agentId, missingDeps })
  return null
}

// 3. å¯åŠ¨ PTY è¿›ç¨‹
const pty = spawn(shell, shellArgs, {
  name: 'xterm-color',
  cols: 80,
  rows: 24,
  cwd: workDir,
  env: envVars
})

// 4. ç›‘å¬è¾“å‡º
pty.onData((data) => {
  webContents.send('acp-init:output', { type: 'stdout', data })
})

// 5. æ³¨å…¥åˆå§‹åŒ–å‘½ä»¤
pty.write(initCmd + '\n')
```

### 4.3 IPC äº‹ä»¶

| äº‹ä»¶å | æ–¹å‘ | æ•°æ® | è¯´æ˜ |
|--------|------|------|------|
| `acp-init:start` | Main â†’ Renderer | `{ command: string }` | ç»ˆç«¯å¯åŠ¨ |
| `acp-init:output` | Main â†’ Renderer | `{ type: 'stdout', data: string }` | ç»ˆç«¯è¾“å‡º |
| `acp-init:exit` | Main â†’ Renderer | `{ code: number, signal: string }` | è¿›ç¨‹é€€å‡º |
| `external-deps-required` | Main â†’ Renderer | `{ agentId, missingDeps }` | ç¼ºå°‘ä¾èµ– |
| `acp-terminal:input` | Renderer â†’ Main | `string` | ç”¨æˆ·è¾“å…¥ |
| `acp-terminal:kill` | Renderer â†’ Main | - | ç»ˆæ­¢è¿›ç¨‹ |

---

## 5. ä¾èµ–å¯¹è¯æ¡†

### 5.1 ç»„ä»¶ä½ç½®

**æ–‡ä»¶**: `src/renderer/settings/components/AcpDependencyDialog.vue`

### 5.2 æ˜¾ç¤ºå†…å®¹

å¯¹äºæ¯ä¸ªç¼ºå¤±çš„ä¾èµ–ï¼Œæ˜¾ç¤ºï¼š

1. **ä¾èµ–åç§°**ï¼šå¦‚ "Git Bash"
2. **æè¿°**ï¼šå¦‚ "Git for Windows includes Git Bash"
3. **å®‰è£…å‘½ä»¤**ï¼š
   - winget: `winget install Git.Git`
   - chocolatey: `choco install git`
   - scoop: `scoop install git`
4. **ä¸‹è½½é“¾æ¥**ï¼šå¦‚ `https://git-scm.com/download/win`
5. **å¤åˆ¶æŒ‰é’®**ï¼šä¸€é”®å¤åˆ¶å‘½ä»¤åˆ°å‰ªè´´æ¿

### 5.3 ç”¨æˆ·æ“ä½œ

1. æŸ¥çœ‹ç¼ºå¤±çš„ä¾èµ–
2. å¤åˆ¶å®‰è£…å‘½ä»¤
3. åœ¨ç³»ç»Ÿç»ˆç«¯ä¸­æ‰§è¡Œå‘½ä»¤
4. å…³é—­å¯¹è¯æ¡†
5. é‡æ–°ç‚¹å‡»"åˆå§‹åŒ–"æŒ‰é’®

---

## 6. ç¯å¢ƒé…ç½®

### 6.1 å†…ç½® Runtime æ”¯æŒ

DeepChat æ”¯æŒä½¿ç”¨å†…ç½®çš„ Node.js å’Œ uv runtimeï¼š

```typescript
if (useBuiltinRuntime) {
  const uvRuntimePath = this.runtimeHelper.getUvRuntimePath()
  const nodeRuntimePath = this.runtimeHelper.getNodeRuntimePath()

  // æ·»åŠ åˆ° PATH
  allPaths.unshift(uvRuntimePath, nodeRuntimePath)
}
```

### 6.2 é•œåƒæºé…ç½®

æ”¯æŒé…ç½® npm å’Œ uv çš„é•œåƒæºï¼š

```typescript
if (useBuiltinRuntime) {
  if (npmRegistry) {
    env.npm_config_registry = npmRegistry
    env.NPM_CONFIG_REGISTRY = npmRegistry
  }

  if (uvRegistry) {
    env.UV_DEFAULT_INDEX = uvRegistry
    env.PIP_INDEX_URL = uvRegistry
  }
}
```

### 6.3 Windows ç‰¹æ®Šå¤„ç†

åœ¨ Windows ç³»ç»Ÿå®‰è£…ç›®å½•ä¸‹ï¼Œè‡ªåŠ¨è®¾ç½® npm prefix åˆ°ç”¨æˆ·ç›®å½•ï¼š

```typescript
if (process.platform === 'win32' && isInstalledInSystemDirectory()) {
  const userNpmPrefix = getUserNpmPrefix()
  env.npm_config_prefix = userNpmPrefix
  env.NPM_CONFIG_PREFIX = userNpmPrefix
}
```

---

## 7. ç”¨æˆ·ä½“éªŒæµç¨‹

### 7.1 å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·æ‰“å¼€ ACP è®¾ç½®
    â†“
çœ‹åˆ° Agent åˆ—è¡¨ï¼ˆKimi CLI, Claude Code, Codex, ...ï¼‰
    â†“
ç‚¹å‡»æŸä¸ª Agent çš„"åˆå§‹åŒ–"æŒ‰é’®
    â†“
[åå°] æ£€æŸ¥å¤–éƒ¨ä¾èµ–
    â†“
ç¼ºå°‘ä¾èµ–ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ˜¾ç¤ºä¾èµ–å¯¹è¯æ¡†
    â”‚         â†“
    â”‚      ç”¨æˆ·æŸ¥çœ‹å®‰è£…æŒ‡å—
    â”‚         â†“
    â”‚      ç”¨æˆ·æ‰‹åŠ¨å®‰è£…ä¾èµ–
    â”‚         â†“
    â”‚      ç”¨æˆ·é‡æ–°ç‚¹å‡»"åˆå§‹åŒ–"
    â”‚
    â””â”€ å¦ â†’ æ‰“å¼€ç»ˆç«¯å¯¹è¯æ¡†
              â†“
           æ˜¾ç¤ºå®æ—¶å®‰è£…è¾“å‡º
              â†“
           å®‰è£…æˆåŠŸï¼Ÿ
              â”œâ”€ æ˜¯ â†’ æ˜¾ç¤ºç»¿è‰²çŠ¶æ€ âœ“
              â”‚         â†“
              â”‚      Agent å¯ç”¨
              â”‚
              â””â”€ å¦ â†’ æ˜¾ç¤ºçº¢è‰²çŠ¶æ€ âœ—
                        â†“
                     æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
```

### 7.2 UI æˆªå›¾æè¿°

#### ä¾èµ–å¯¹è¯æ¡†
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼ºå°‘ä¾èµ–                                  [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»¥ä¸‹ä¾èµ–éœ€è¦å®‰è£…æ‰èƒ½ä½¿ç”¨æ­¤ Agentï¼š              â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Git Bash                                  â”‚ â”‚
â”‚  â”‚ Git for Windows includes Git Bash        â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ å®‰è£…å‘½ä»¤ï¼š                                 â”‚ â”‚
â”‚  â”‚ winget install Git.Git          [å¤åˆ¶]   â”‚ â”‚
â”‚  â”‚ choco install git               [å¤åˆ¶]   â”‚ â”‚
â”‚  â”‚ scoop install git               [å¤åˆ¶]   â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ ä¸‹è½½é“¾æ¥ï¼š                                 â”‚ â”‚
â”‚  â”‚ https://git-scm.com/download/win [å¤åˆ¶]  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”‚                                    [å…³é—­]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç»ˆç«¯å¯¹è¯æ¡†
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå§‹åŒ– OpenCode                           [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â— è¿è¡Œä¸­                            [ç²˜è´´]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ $ npm i -g opencode-ai                         â”‚ â”‚
â”‚ â”‚ npm WARN deprecated ...                     â”‚ â”‚
â”‚ â”‚ added 123 packages in 5s                    â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ $ opencode --version                        â”‚ â”‚
â”‚ â”‚ 1.1.21                                      â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ âœ“ å®‰è£…æˆåŠŸ                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ä¸º OpenCode æ·»åŠ æ”¯æŒ

### 8.1 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **ç±»å‹å®šä¹‰** (`src/shared/presenter/config.ts`)
   ```typescript
   export type AcpBuiltinAgentId =
     | 'kimi-cli'
     | 'claude-code-acp'
     | 'codex-acp'
     | 'opencode'  // æ–°å¢
   ```

2. **é…ç½®åŠ©æ‰‹** (`src/main/presenter/configPresenter/acpConfHelper.ts`)
   ```typescript
   const BUILTIN_ORDER: AcpBuiltinAgentId[] = [
     'kimi-cli', 'claude-code-acp', 'codex-acp', 'opencode'
   ]

   const BUILTIN_TEMPLATES = {
     'opencode': {
       name: 'OpenCode',
       defaultProfile: () => ({
         name: 'Default',
         command: 'opencode',
         args: ['acp'],
         env: {}
       })
     }
   }
   ```

3. **åˆå§‹åŒ–åŠ©æ‰‹** (`src/main/presenter/configPresenter/acpInitHelper.ts`)
   ```typescript
   const BUILTIN_INIT_COMMANDS = {
     'opencode': {
       commands: ['npm i -g opencode-ai', 'opencode --version'],
       description: 'Initialize OpenCode'
     }
   }
   ```

### 8.2 OpenCode çš„ç‰¹æ®Šä¹‹å¤„

- **æ— éœ€å¤–éƒ¨ä¾èµ–**ï¼šOpenCode ä¸éœ€è¦ Git Bash ç­‰ç‰¹æ®Šä¾èµ–
- **ç®€å•å®‰è£…**ï¼šåªéœ€ `npm i -g opencode-ai`
- **æ ‡å‡† ACP**ï¼šå®Œå…¨ç¬¦åˆ ACP åè®®è§„èŒƒ

---

## 9. å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | å…³é”®æ–¹æ³•/é…ç½® |
|------|---------|--------------|
| åˆå§‹åŒ–å‘½ä»¤é…ç½® | `src/main/presenter/configPresenter/acpInitHelper.ts` | `BUILTIN_INIT_COMMANDS` |
| å¤–éƒ¨ä¾èµ–é…ç½® | `src/main/presenter/configPresenter/acpInitHelper.ts` | `EXTERNAL_DEPENDENCIES` |
| ä¾èµ–æ£€æµ‹é€»è¾‘ | `src/main/presenter/configPresenter/acpInitHelper.ts` | `checkExternalDependency()` |
| ç»ˆç«¯ä¼šè¯å¯åŠ¨ | `src/main/presenter/configPresenter/acpInitHelper.ts` | `startInteractiveSession()` |
| ç»ˆç«¯å¯¹è¯æ¡† UI | `src/renderer/settings/components/AcpTerminalDialog.vue` | æ•´ä¸ªç»„ä»¶ |
| ä¾èµ–å¯¹è¯æ¡† UI | `src/renderer/settings/components/AcpDependencyDialog.vue` | æ•´ä¸ªç»„ä»¶ |
| ACP è®¾ç½®é¡µé¢ | `src/renderer/settings/components/AcpSettings.vue` | `handleDependenciesRequired()` |

---

## 10. æ€»ç»“

### 10.1 ä¼˜ç‚¹

âœ… **ç”¨æˆ·å‹å¥½**ï¼šæä¾›å›¾å½¢åŒ–çš„å®‰è£…ç•Œé¢ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
âœ… **å®æ—¶åé¦ˆ**ï¼šæ˜¾ç¤ºå®‰è£…è¿‡ç¨‹çš„å®æ—¶è¾“å‡º
âœ… **ä¾èµ–æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºç¼ºå¤±çš„ä¾èµ–
âœ… **å¤šç§å®‰è£…æ–¹å¼**ï¼šæ”¯æŒ wingetã€chocolateyã€scoop ç­‰
âœ… **ç¯å¢ƒéš”ç¦»**ï¼šæ”¯æŒå†…ç½® runtimeï¼Œé¿å…æ±¡æŸ“ç³»ç»Ÿç¯å¢ƒ
âœ… **é•œåƒæºæ”¯æŒ**ï¼šæ”¯æŒé…ç½® npm å’Œ uv é•œåƒæº

### 10.2 è®¾è®¡äº®ç‚¹

1. **ä¸‰å±‚æ£€æµ‹æœºåˆ¶**ï¼šå‘½ä»¤æ£€æµ‹ â†’ è·¯å¾„æ£€æµ‹ â†’ ç³»ç»Ÿå·¥å…·æ£€æµ‹
2. **PTY è¿›ç¨‹**ï¼šä½¿ç”¨ node-pty åˆ›å»ºçœŸå®çš„ç»ˆç«¯ç¯å¢ƒ
3. **IPC é€šä¿¡**ï¼šä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹é€šè¿‡äº‹ä»¶é€šä¿¡
4. **é”™è¯¯å¤„ç†**ï¼šå‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
5. **è·¨å¹³å°æ”¯æŒ**ï¼šWindowsã€macOSã€Linux ç»Ÿä¸€ä½“éªŒ

### 10.3 é€‚ç”¨äº OpenCode

OpenCode çš„é›†æˆéå¸¸ç®€å•ï¼Œå› ä¸ºï¼š
- âœ… æ— éœ€ç‰¹æ®Šå¤–éƒ¨ä¾èµ–
- âœ… æ ‡å‡† npm å®‰è£…
- âœ… å®Œå…¨ç¬¦åˆ ACP åè®®
- âœ… åªéœ€æ·»åŠ é…ç½®ï¼Œæ— éœ€ä¿®æ”¹é€»è¾‘

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-15
**ä½œè€…**: DeepChat Team
