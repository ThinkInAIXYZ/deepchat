# 通过对话控制设置

## 概述

允许用户在对话中使用自然语言更新 DeepChat 设置中一小部分安全的子集。更改必须经过验证、持久化，并立即生效。对于复杂/高风险设置（例如 MCP 配置、提示词），助手不得直接应用更改；相反，它应该说明在哪里编辑它们并自动打开设置（理想情况下深度链接到相关部分）。

此规范有意分为两个增量：

- **步骤 1**：提供一个安全的、经过验证的设置应用 API（主进程），可以从受控的入口点（渲染器 UI 和/或代理工具）调用以更改设置并触发实时更新。
- **步骤 2**：以**DeepChat 技能**的形式交付自然语言行为，以便仅在相关时注入额外的上下文。

## 目标

- 允许在对话内更新：
  - 开关设置：音效、复制 COT 详情。
  - 枚举设置：语言、主题、字体大小。
- 立即应用更改（当前窗口 + 相关的其他窗口）。
- 将更改持久化到现有配置存储。
- 保持表面积安全：不暴露任意配置键。
- 使用技能控制上下文：
  - 设置修改指导**必须仅在**用户实际请求更改 DeepChat 设置时注入。

## 非目标

- 不允许用户通过聊天直接设置任意的 `ConfigPresenter.setSetting(key, value)` 键。
- 不允许通过聊天设置敏感值（API 密钥、令牌、环境变量、文件路径、命令参数）。
- 不实现通过自然语言编辑 MCP 服务器、提示词、提供者或其他复杂嵌套配置。
- 不更改设置在磁盘上的存储方式（此功能中无迁移）。

## 用户故事

- 作为用户，我可以说"开启音效"，它立即启用音效。
- 作为用户，我可以说"复制时复制 COT 详情"，它启用/禁用该开关。
- 作为用户，我可以说"将语言设置为英语"，UI 语言立即切换。
- 作为用户，我可以说"使用深色主题"或"跟随系统主题"，主题立即更新。
- 作为用户，我可以说"使文本更大"，字体大小立即更改。
- 作为用户，如果我询问"添加 MCP 服务器"或"编辑提示词"，助手会告诉我在设置中的哪里操作，并在该位置打开设置。

## 验收标准

### 步骤 1：安全设置应用 API（无 NLP）

- 存在一个主进程 API，接受受限的、经过验证的请求以更改一个支持的设置。
- 只有此规范中允许列表的设置可以通过此 API 更改。
- 当 `deepchat-settings` 技能**未**活动时，设置工具**不会**注入到 LLM 工具列表中。
- 成功时：
  - 设置值被持久化（现有底层存储）。
  - 更改在当前渲染器中立即生效。
  - 在现有事件流支持的地方进行跨窗口/选项卡更新（例如主题/语言/字体大小/音效）。
- 失败时：
  - 无效输入被拒绝，返回结构化的、用户可呈现的错误（无部分写入）。
- API 可以安全地使用不受信任的输入调用（严格验证 + 允许列表）。

### 步骤 2：通过技能的自然语言（上下文控制）

- 存在内置技能（建议：`deepchat-settings`）描述此功能。
- 该技能**不**旨在默认保持活动：
  - 它应仅在用户请求更改 DeepChat 自身设置时激活。
  - 它应在设置更改完成后停用。
- 活动时，助手：
  - 解释用户意图，规范化为规范值，并调用步骤 1 API。
  - 对于不允许/复杂的设置（MCP、提示词等），提供指导并打开设置到最佳匹配位置。

## 开放问题 [需要澄清]

1. 技能的模式可用性
   - 技能提示注入当前似乎与 `chatMode === 'agent'` 绑定。我们希望此功能在以下情况下工作：
     - 仅代理模式（建议的第一个增量），或
     - 亦在聊天/ACP 代理模式下（需要额外工作）？
2. 字体大小表示
   - 聊天应使用语义标签（`small/medium/large`）映射到 `fontSizeLevel`，还是接受明确的数字级别？
3. 设置深度链接目标
   - 我们希望支持深度链接的规范设置选项卡/部分 ID 是什么（例如 `mcp`、`prompts`、`appearance`、`language`）？
4. UX：确认 vs 静默应用
   - 助手应始终在应用更改前确认，还是立即应用并附带"撤销"功能？

## 安全与隐私说明

- 步骤 1 API 必须：
  - 使用设置 ID 的允许列表。
  - 验证输入类型和枚举范围。
  - 避免任何通用的"设置任意键"功能。
- 纵深防御（推荐）：设置工具/入口点应在应用前验证相关技能对对话是否活动。
- 步骤 2 不得允许间接权限升级：
  - 不得通过自然语言更改文件系统路径、命令参数、环境变量或承载机密的设置。
