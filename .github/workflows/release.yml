name: Create Release

on:
  workflow_dispatch:
    inputs:
      workflow_id:
        description: 'Build workflow run ID to use for artifacts'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts from workflow
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow_conclusion: success
          run_id: ${{ github.event.inputs.workflow_id }}
          path: artifacts

      - name: List downloaded artifacts
        run: find artifacts -type f | sort

      - name: Get build run info
        id: build_run
        uses: actions/github-script@v7
        with:
          script: |
            const runId = Number('${{ github.event.inputs.workflow_id }}')
            const { data } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            })
            core.setOutput('sha', data.head_sha)

      - name: Get version number
        id: get_version
        run: |
          VERSION_FILE=$(find artifacts/deepchat-linux-x64 -name "DeepChat-*.tar.gz" | head -n 1)
          if [ -n "$VERSION_FILE" ]; then
            VERSION=$(echo "$VERSION_FILE" | grep -oE 'DeepChat-[0-9]+\.[0-9]+\.[0-9]+(-(beta|alpha)\.[0-9]+)?' | sed 's/DeepChat-//')
            if [ -z "$VERSION" ]; then
              echo "Error: Failed to parse version from $VERSION_FILE"
              exit 1
            fi
            if echo "$VERSION" | grep -qE '-(beta|alpha)\.'; then
              echo "prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "prerelease=false" >> $GITHUB_OUTPUT
            fi
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Found version: $VERSION"
          else
            echo "Error: DeepChat tar.gz file not found"
            exit 1
          fi

      - name: Checkout build commit
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.build_run.outputs.sha }}
          fetch-depth: 1

      - name: Build release notes from CHANGELOG
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          CHANGELOG="CHANGELOG.md"
          if [ ! -f "$CHANGELOG" ]; then
            echo "Error: CHANGELOG.md not found"
            exit 1
          fi
          HEADER_REGEX="^## v${VERSION} \\([0-9]{4}-[0-9]{2}-[0-9]{2}\\)$"
          if ! grep -Eq "$HEADER_REGEX" "$CHANGELOG"; then
            echo "Error: Changelog entry not found for v${VERSION}"
            exit 1
          fi
          awk -v ver="v${VERSION}" '
            $0 ~ "^## " ver " \\(" { in_section = 1 }
            in_section && $0 ~ "^## " && $0 !~ "^## " ver " \\(" { exit }
            in_section { print }
          ' "$CHANGELOG" > release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "Error: Release notes are empty for v${VERSION}"
            exit 1
          fi

      - name: Prepare release assets
        run: |
          mkdir -p release_assets

          # Process Windows x64 artifacts
          if [ -d "artifacts/deepchat-win-x64" ]; then
            cp artifacts/deepchat-win-x64/*.exe release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-win-x64/*.msi release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-win-x64/*.zip release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-win-x64/*.yml release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-win-x64/*.blockmap release_assets/ 2>/dev/null || true
          fi

          # Process Windows arm64 artifacts
          #if [ -d "artifacts/deepchat-win-arm64" ]; then
          #  cp artifacts/deepchat-win-arm64/*.exe release_assets/ 2>/dev/null || true
          #  cp artifacts/deepchat-win-arm64/*.msi release_assets/ 2>/dev/null || true
          #  cp artifacts/deepchat-win-arm64/*.zip release_assets/ 2>/dev/null || true
          #fi

          # Process Linux x64 artifacts
          if [ -d "artifacts/deepchat-linux-x64" ]; then
            cp artifacts/deepchat-linux-x64/*.AppImage release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.deb release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.rpm release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.tar.gz release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.yml release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-linux-x64/*.blockmap release_assets/ 2>/dev/null || true
          fi

          # Process Mac x64 artifacts
          if [ -d "artifacts/deepchat-mac-x64" ]; then
            cp artifacts/deepchat-mac-x64/*.dmg release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-mac-x64/*.zip release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-mac-x64/*.blockmap release_assets/ 2>/dev/null || true
          fi

          # Process Mac arm64 artifacts
          if [ -d "artifacts/deepchat-mac-arm64" ]; then
            cp artifacts/deepchat-mac-arm64/*.dmg release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-mac-arm64/*.zip release_assets/ 2>/dev/null || true
            cp artifacts/deepchat-mac-arm64/*.blockmap release_assets/ 2>/dev/null || true
          fi

          merge_mac_yml() {
            local name="$1"
            local x64="artifacts/deepchat-mac-x64/$name"
            local arm64="artifacts/deepchat-mac-arm64/$name"
            if [ -f "$x64" ] && [ -f "$arm64" ]; then
              ruby -ryaml -e '
                x64 = YAML.load_file(ARGV[0]) || {}
                arm = YAML.load_file(ARGV[1]) || {}
                merged = x64.dup
                merged["version"] ||= arm["version"]
                merged["releaseDate"] ||= arm["releaseDate"]
                merged["releaseNotes"] ||= arm["releaseNotes"]
                merged["path"] ||= arm["path"]
                merged["sha512"] ||= arm["sha512"]
                files = []
                files.concat(x64["files"]) if x64["files"].is_a?(Array)
                files.concat(arm["files"]) if arm["files"].is_a?(Array)
                merged["files"] = files.uniq { |f| f["url"] }
                File.write(ARGV[2], merged.to_yaml)
              ' "$x64" "$arm64" "release_assets/$name"
            elif [ -f "$x64" ]; then
              cp "$x64" "release_assets/$name"
            elif [ -f "$arm64" ]; then
              cp "$arm64" "release_assets/$name"
            fi
          }

          merge_mac_yml latest-mac.yml
          merge_mac_yml beta-mac.yml

          ls -la release_assets/

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: DeepChat V${{ steps.get_version.outputs.version }}
          draft: true
          prerelease: ${{ steps.get_version.outputs.prerelease == 'true' }}
          files: |
            release_assets/*
          body_path: release_notes.md

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
